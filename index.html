<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QR Code Attendance System</title>
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.0.11/dist/html5-qrcode.min.js"></script>
    <style>
         :root {
            --primary: #4a6bff;
            --secondary: #6c757d;
            --success: #28a745;
            --danger: #dc3545;
            --light: #f8f9fa;
            --dark: #343a40;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .description {
            color: var(--secondary);
            margin-bottom: 20px;
        }
        
        .mode-toggle {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }
        
        .mode-btn {
            padding: 10px 20px;
            border: none;
            background-color: white;
            color: var(--primary);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            border: 2px solid var(--primary);
        }
        
        .mode-btn:first-child {
            border-radius: 5px 0 0 5px;
        }
        
        .mode-btn:last-child {
            border-radius: 0 5px 5px 0;
        }
        
        .mode-btn.active {
            background-color: var(--primary);
            color: white;
        }
        
        .mode-content {
            display: none;
        }
        
        .mode-content.active {
            display: block;
        }
        
        .card {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .card h2 {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--dark);
        }
        
        input,
        select,
        button {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        button {
            background-color: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
            margin-top: 10px;
        }
        
        button:hover {
            background-color: #3a58e8;
        }
        
        .btn-secondary {
            background-color: var(--secondary);
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        .btn-danger {
            background-color: var(--danger);
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        .btn-success {
            background-color: var(--success);
        }
        
        .btn-success:hover {
            background-color: #218838;
        }
        
        #qr-code {
            margin: 20px 0;
            display: flex;
            justify-content: center;
        }
        
        #scanner-container {
            margin: 20px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        #reader {
            width: 100%;
            max-width: 500px;
        }
        
        #scan-result {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            display: none;
        }
        
        .attendance-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .attendance-table th,
        .attendance-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .attendance-table th {
            background-color: var(--primary);
            color: white;
        }
        
        .attendance-table tr:hover {
            background-color: #f5f5f5;
        }
        
        .present {
            color: var(--success);
            font-weight: bold;
        }
        
        .absent {
            color: var(--danger);
        }
        
        .subject-selector {
            margin-bottom: 20px;
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .floating-alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background-color: var(--success);
            color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s;
        }
        
        .floating-alert.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            .mode-btn {
                padding: 8px 15px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>QR Code Attendance System</h1>
            <p class="description">
                Efficient attendance tracking using QR codes for educational institutions
            </p>
        </header>

        <div class="mode-toggle">
            <button class="mode-btn active" data-mode="teacher">
          Teacher Mode
        </button>
            <button class="mode-btn" data-mode="student">Student Mode</button>
        </div>

        <!-- Teacher Mode Content -->
        <div id="teacher-mode" class="mode-content active">
            <div class="card">
                <h2>Manage Subjects</h2>

                <div class="form-group">
                    <label for="subject-name">Subject Name</label>
                    <input type="text" id="subject-name" placeholder="Enter subject name" />
                </div>

                <div class="form-group">
                    <label for="teacher-name">Teacher Name</label>
                    <input type="text" id="teacher-name" placeholder="Enter your name" />
                </div>

                <button id="create-subject" class="btn-success">
            Create Subject
          </button>

                <div class="subject-selector">
                    <label for="subject-select">Select Subject</label>
                    <select id="subject-select">
              <option value="">Select a subject</option>
            </select>
                </div>
            </div>

            <div class="card">
                <h2>Generate QR Code</h2>
                <p>Select a subject above to generate a QR code for attendance</p>

                <div id="qr-code"></div>

                <button id="generate-qr" class="btn-secondary" disabled>
            Generate Attendance QR Code
          </button>
                <button id="end-session" class="btn-danger" disabled>
            End Current Session
          </button>
            </div>

            <div class="card">
                <h2>Attendance Records</h2>

                <div class="export-buttons">
                    <button id="export-csv" class="btn-secondary">Export as CSV</button>
                    <button id="export-json" class="btn-secondary">
              Export as JSON
            </button>
                </div>

                <div id="records-container">
                    <p>Select a subject to view attendance records</p>
                </div>
            </div>
        </div>

        <!-- Student Mode Content -->
        <div id="student-mode" class="mode-content">
            <div class="card">
                <h2>Scan Attendance QR Code</h2>
                <p>
                    Position the QR code within the frame below to mark your attendance
                </p>

                <div id="scanner-container">
                    <div id="reader" width="500px"></div>
                    <div id="scan-result"></div>
                </div>

                <div class="form-group">
                    <label for="student-id">Student ID</label>
                    <input type="text" id="student-id" placeholder="Enter your student ID" />
                </div>

                <div class="form-group">
                    <label for="student-name">Student Name</label>
                    <input type="text" id="student-name" placeholder="Enter your name" />
                </div>

                <button id="manual-attendance" class="btn-success">
            Mark Attendance Manually
          </button>
            </div>
        </div>

        <div id="alert" class="floating-alert"></div>
    </div>

    <script>
        // Database simulation using localStorage
        const DB = {
            subjects: JSON.parse(localStorage.getItem("subjects")) || [],
            attendance: JSON.parse(localStorage.getItem("attendance")) || {},

            save: function() {
                localStorage.setItem("subjects", JSON.stringify(this.subjects));
                localStorage.setItem("attendance", JSON.stringify(this.attendance));
            },

            addSubject: function(name, teacher) {
                const subject = {
                    id: Date.now().toString(),
                    name: name,
                    teacher: teacher,
                    active: false,
                    qrData: null,
                    createdAt: new Date().toISOString(),
                };

                this.subjects.push(subject);
                this.save();
                return subject;
            },

            getSubject: function(id) {
                return this.subjects.find((subject) => subject.id === id);
            },

            activateSubject: function(id) {
                this.subjects.forEach((subject) => {
                    subject.active = subject.id === id;
                });
                this.save();
            },

            deactivateAll: function() {
                this.subjects.forEach((subject) => {
                    subject.active = false;
                    subject.qrData = null;
                });
                this.save();
            },

            generateQRData: function(subjectId) {
                // Generate a unique QR data with timestamp
                const subject = this.getSubject(subjectId);
                if (subject) {
                    subject.qrData = JSON.stringify({
                        subjectId: subject.id,
                        timestamp: Date.now(),
                    });
                    this.save();
                    return subject.qrData;
                }
                return null;
            },

            recordAttendance: function(qrData, studentId, studentName) {
                try {
                    const data = JSON.parse(qrData);
                    const subjectId = data.subjectId;
                    const subject = DB.getSubject(subjectId);

                    if (!subject) {
                        throw new Error("Invalid subject");
                    }

                    if (!this.attendance[subjectId]) {
                        this.attendance[subjectId] = {
                            subjectId: subjectId,
                            subjectName: subject.name,
                            records: [],
                        };
                    }

                    // Check if student already marked attendance
                    const existingRecord = this.attendance[subjectId].records.find(
                        (record) => record.studentId === studentId
                    );

                    if (existingRecord) {
                        existingRecord.timestamp = new Date().toISOString();
                        existingRecord.status = "present";
                    } else {
                        this.attendance[subjectId].records.push({
                            studentId: studentId,
                            studentName: studentName,
                            timestamp: new Date().toISOString(),
                            status: "present",
                        });
                    }

                    this.save();
                    return {
                        subjectName: subject.name,
                        studentName: studentName,
                    };
                } catch (e) {
                    console.error("Error recording attendance:", e);
                    return null;
                }
            },

            getAttendanceForSubject: function(subjectId) {
                return (
                    this.attendance[subjectId] || {
                        subjectId: subjectId,
                        subjectName:
                            (this.getSubject(subjectId) &&
                                this.getSubject(subjectId).name) ||
                            "Unknown",
                        records: [],
                    }
                );
            },

            exportAsCSV: function(subjectId) {
                const data = this.getAttendanceForSubject(subjectId);
                let csv = "Student ID,Student Name,Timestamp,Status\n";

                data.records.forEach((record) => {
                    csv += `${record.studentId},"${record.studentName}",${record.timestamp},${record.status}\n`;
                });

                return csv;
            },
        };

        // DOM Elements
        const teacherModeBtn = document.querySelector('[data-mode="teacher"]');
        const studentModeBtn = document.querySelector('[data-mode="student"]');
        const teacherModeContent = document.getElementById("teacher-mode");
        const studentModeContent = document.getElementById("student-mode");
        const subjectNameInput = document.getElementById("subject-name");
        const teacherNameInput = document.getElementById("teacher-name");
        const createSubjectBtn = document.getElementById("create-subject");
        const subjectSelect = document.getElementById("subject-select");
        const generateQRBtn = document.getElementById("generate-qr");
        const endSessionBtn = document.getElementById("end-session");
        const qrCodeDiv = document.getElementById("qr-code");
        const recordsContainer = document.getElementById("records-container");
        const exportCsvBtn = document.getElementById("export-csv");
        const exportJsonBtn = document.getElementById("export-json");
        const studentIdInput = document.getElementById("student-id");
        const studentNameInput = document.getElementById("student-name");
        const manualAttendanceBtn = document.getElementById("manual-attendance");
        const scanResultDiv = document.getElementById("scan-result");
        const alertDiv = document.getElementById("alert");

        // Initialize QR scanner
        let html5QrcodeScanner;

        // Mode switching
        teacherModeBtn.addEventListener("click", () => {
            teacherModeBtn.classList.add("active");
            studentModeBtn.classList.remove("active");
            teacherModeContent.classList.add("active");
            studentModeContent.classList.remove("active");
            stopScanner();
        });

        studentModeBtn.addEventListener("click", () => {
            studentModeBtn.classList.add("active");
            teacherModeBtn.classList.remove("active");
            studentModeContent.classList.add("active");
            teacherModeContent.classList.remove("active");
            initScanner();
        });

        // Teacher functionality
        createSubjectBtn.addEventListener("click", () => {
            const subjectName = subjectNameInput.value.trim();
            const teacherName = teacherNameInput.value.trim();

            if (!subjectName || !teacherName) {
                showAlert("Please enter both subject and teacher names", "danger");
                return;
            }

            const subject = DB.addSubject(subjectName, teacherName);
            updateSubjectSelect();
            subjectNameInput.value = "";
            teacherNameInput.value = "";
            showAlert(`Subject "${subject.name}" created successfully!`);
        });

        subjectSelect.addEventListener("change", (e) => {
            const subjectId = e.target.value;
            if (subjectId) {
                generateQRBtn.disabled = false;
                updateAttendanceRecords(subjectId);
            } else {
                generateQRBtn.disabled = true;
                recordsContainer.innerHTML =
                    "<p>Select a subject to view attendance records</p>";
                qrCodeDiv.innerHTML = "";
                endSessionBtn.disabled = true;
            }
        });

        generateQRBtn.addEventListener("click", () => {
            const subjectId = subjectSelect.value;
            if (subjectId) {
                DB.deactivateAll();
                DB.activateSubject(subjectId);
                const qrData = DB.generateQRData(subjectId);

                if (qrData) {
                    qrCodeDiv.innerHTML = "";
                    new QRCode(qrCodeDiv, {
                        text: qrData,
                        width: 200,
                        height: 200,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.H,
                    });

                    const subject = DB.getSubject(subjectId);
                    showAlert(
                        `QR code generated for ${subject.name}. Show this to students for scanning.`
                    );
                    endSessionBtn.disabled = false;
                }
            }
        });

        endSessionBtn.addEventListener("click", () => {
            DB.deactivateAll();
            qrCodeDiv.innerHTML = "";
            endSessionBtn.disabled = true;
            showAlert("Attendance session ended. QR code is no longer valid.");
        });

        exportCsvBtn.addEventListener("click", () => {
            const subjectId = subjectSelect.value;
            if (subjectId) {
                const csv = DB.exportAsCSV(subjectId);
                const blob = new Blob([csv], {
                    type: "text/csv;charset=utf-8;",
                });
                const subjectName = DB.getSubject(subjectId)
                    .name.replace(/[^a-z0-9]/gi, "_")
                    .toLowerCase();
                saveAs(blob, `attendance_${subjectName}.csv`);
                showAlert("Attendance data exported as CSV", "success");
            } else {
                showAlert("Please select a subject first", "danger");
            }
        });

        exportJsonBtn.addEventListener("click", () => {
            const subjectId = subjectSelect.value;
            if (subjectId) {
                const data = DB.getAttendanceForSubject(subjectId);
                const json = JSON.stringify(data, null, 2);
                const blob = new Blob([json], {
                    type: "application/json;charset=utf-8;",
                });
                const subjectName = DB.getSubject(subjectId)
                    .name.replace(/[^a-z0-9]/gi, "_")
                    .toLowerCase();
                saveAs(blob, `attendance_${subjectName}.json`);
                showAlert("Attendance data exported as JSON", "success");
            } else {
                showAlert("Please select a subject first", "danger");
            }
        });

        // Student functionality
        function initScanner() {
            if (!window.Html5QrcodeScanner) {
                showAlert("QR scanner library not loaded", "danger");
                return;
            }

            html5QrcodeScanner = new Html5QrcodeScanner(
                "reader", {
                    fps: 10,
                    qrbox: 250,
                    rememberLastUsedCamera: true,
                },
                /* verbose= */
                false
            );

            function onScanSuccess(decodedText, decodedResult) {
                const studentId = studentIdInput.value.trim();
                const studentName = studentNameInput.value.trim();

                if (!studentId || !studentName) {
                    showAlert("Please enter both student ID and name", "danger");
                    return;
                }

                const result = DB.recordAttendance(
                    decodedText,
                    studentId,
                    studentName
                );
                if (result) {
                    scanResultDiv.innerHTML = `
                      <p><strong>Attendance recorded successfully!</strong></p>
                      <p>Subject: ${result.subjectName}</p>
                      <p>Student: ${result.studentName}</p>
                      <p>Time: ${new Date().toLocaleString()}</p>
                  `;
                    scanResultDiv.style.display = "block";
                    scanResultDiv.style.backgroundColor = "#e8f5e9";
                    showAlert("Attendance recorded successfully!", "success");
                } else {
                    scanResultDiv.innerHTML =
                        "<p>Invalid QR code. Please scan a valid attendance QR code.</p>";
                    scanResultDiv.style.display = "block";
                    scanResultDiv.style.backgroundColor = "#ffebee";
                    showAlert("Invalid QR code", "danger");
                }
            }

            html5QrcodeScanner.render(onScanSuccess);
        }

        function stopScanner() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.clear().catch((error) => {
                    console.error("Failed to clear QR scanner", error);
                });
                document.getElementById("reader").innerHTML = "";
                scanResultDiv.style.display = "none";
            }
        }

        manualAttendanceBtn.addEventListener("click", () => {
            const qrData = prompt("Enter the QR code data manually:");
            if (qrData) {
                const studentId = studentIdInput.value.trim();
                const studentName = studentNameInput.value.trim();

                if (!studentId || !studentName) {
                    showAlert("Please enter both student ID and name", "danger");
                    return;
                }

                const result = DB.recordAttendance(qrData, studentId, studentName);
                if (result) {
                    scanResultDiv.innerHTML = `
                      <p><strong>Attendance recorded successfully!</strong></p>
                      <p>Subject: ${result.subjectName}</p>
                      <p>Student: ${result.studentName}</p>
                      <p>Time: ${new Date().toLocaleString()}</p>
                  `;
                    scanResultDiv.style.display = "block";
                    scanResultDiv.style.backgroundColor = "#e8f5e9";
                    showAlert("Attendance recorded successfully!", "success");
                } else {
                    scanResultDiv.innerHTML =
                        "<p>Invalid QR code data. Please enter valid data.</p>";
                    scanResultDiv.style.display = "block";
                    scanResultDiv.style.backgroundColor = "#ffebee";
                    showAlert("Invalid QR code data", "danger");
                }
            }
        });

        // Helper functions
        function updateSubjectSelect() {
            subjectSelect.innerHTML = '<option value="">Select a subject</option>';
            DB.subjects.forEach((subject) => {
                const option = document.createElement("option");
                option.value = subject.id;
                option.textContent = `${subject.name} (${subject.teacher})`;
                subjectSelect.appendChild(option);
            });
        }

        function updateAttendanceRecords(subjectId) {
            const attendance = DB.getAttendanceForSubject(subjectId);

            if (attendance.records.length === 0) {
                recordsContainer.innerHTML =
                    "<p>No attendance records found for this subject</p>";
                return;
            }

            let html = `
              <h3>Attendance for ${attendance.subjectName}</h3>
              <div class="table-responsive">
                  <table class="attendance-table">
                      <thead>
                          <tr>
                              <th>Student ID</th>
                              <th>Student Name</th>
                              <th>Time</th>
                              <th>Status</th>
                          </tr>
                      </thead>
                      <tbody>
          `;

            attendance.records.forEach((record) => {
                html += `
                  <tr>
                      <td>${record.studentId}</td>
                      <td>${record.studentName}</td>
                      <td>${new Date(record.timestamp).toLocaleString()}</td>
                      <td class="${
                        record.status === "present" ? "present" : "absent"
                      }">
                          ${record.status.toUpperCase()}
                      </td>
                  </tr>
              `;
            });

            html += `
                      </tbody>
                  </table>
              </div>
          `;

            recordsContainer.innerHTML = html;
        }

        function showAlert(message, type = "success") {
            alertDiv.textContent = message;
            alertDiv.className = "floating-alert";

            // Set color based on type
            if (type === "success") {
                alertDiv.style.backgroundColor = "var(--success)";
            } else if (type === "danger") {
                alertDiv.style.backgroundColor = "var(--danger)";
            } else if (type === "warning") {
                alertDiv.style.backgroundColor = "var(--secondary)";
            }

            alertDiv.classList.add("show");

            setTimeout(() => {
                alertDiv.classList.remove("show");
            }, 3000);
        }

        // Initialize the app
        updateSubjectSelect();
    </script>
</body>

</html>